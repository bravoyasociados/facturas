<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Invoice PWA</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
:root{
  --bg:#f2f2f7;
  --card:#fff;
  --text:#000;
  --primary:#007aff;
}
@media(prefers-color-scheme:dark){
  :root{--bg:#000;--card:#1c1c1e;--text:#fff}
}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont;
  background:var(--bg);
  color:var(--text);
}
.app{
  max-width:480px;
  margin:auto;
  padding:20px;
}
.screen{display:none}
.screen.active{display:block}
.card{
  background:var(--card);
  border-radius:18px;
  padding:20px;
  margin-bottom:18px;
}
input,select,button{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:none;
  margin-top:10px;
  font-size:16px;
}
button{background:var(--primary);color:#fff}
.logo{text-align:center;margin:20px 0}
.logo img{max-height:70px}
.small{font-size:13px;opacity:.7}
.list-item{padding:12px;border-bottom:1px solid #ccc}
</style>
</head>

<body>
<div class="app">

<!-- LOGIN -->
<div id="login" class="screen active">
  <div class="logo"><img src="logotipo.jpg"></div>
  <div class="card">
    <h2>Acceso</h2>
    <input type="password" id="pin" placeholder="Código">
    <button onclick="login()">Entrar</button>
  </div>
</div>

<!-- APP -->
<div id="app" class="screen">
  <div class="logo"><img src="logotipo.jpg"></div>

  <!-- NEGOCIO -->
  <div class="card">
    <h3>Negocio</h3>
    <select id="business"></select>
    <input id="newBusiness" placeholder="Nombre del negocio">
    <input type="file" accept="image/*" onchange="loadBizLogo(this)">
    <button onclick="addBusiness()">Agregar negocio</button>
  </div>

  <!-- IVA -->
  <div class="card">
    <h3>IVA</h3>
    <input type="number" id="ivaPercent" placeholder="Ej. 16">
  </div>

  <!-- DOCUMENTO -->
  <div class="card">
    <h3>Documento</h3>
    <select id="type">
      <option>Factura</option>
      <option>Cotización</option>
    </select>
    <input id="client" placeholder="Cliente">
    <input id="concept" placeholder="Concepto">
    <input id="amount" type="number" placeholder="Importe">
    <select id="currency">
      <option>MXN</option>
      <option>USD</option>
      <option>EUR</option>
    </select>
    <button onclick="createPDF()">Guardar y compartir PDF</button>
  </div>

  <!-- HISTORIAL -->
  <div class="card">
    <h3>Historial</h3>
    <div id="history"></div>
  </div>

  <button onclick="logout()">Cerrar sesión</button>
</div>
</div>

<script>
const PIN="28053";
let tempLogo=null;

/* ---------- UI ---------- */
function show(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

/* ---------- LOGIN ---------- */
function login(){
  if(pin.value===PIN){
    show("app");
    initData();
  }else{
    authenticateBiometric();
  }
}
function logout(){show("login")}

async function authenticateBiometric(){
  try{
    await navigator.credentials.get({
      publicKey:{challenge:new Uint8Array(32),userVerification:"required"}
    });
    show("app");
    initData();
  }catch{
    alert("Ingresa el código");
  }
}

/* ---------- DATA INIT ---------- */
function initData(){
  if(!localStorage.getItem("biz")){
    localStorage.setItem("biz", JSON.stringify([
      { name:"Mi Negocio", logo:null }
    ]));
  }
  loadBusinesses();
  loadHistory();
}

/* ---------- NEGOCIOS ---------- */
function loadBizLogo(input){
  const reader=new FileReader();
  reader.onload=e=>tempLogo=e.target.result;
  reader.readAsDataURL(input.files[0]);
}

function addBusiness(){
  if(!newBusiness.value) return;
  const list=JSON.parse(localStorage.getItem("biz"));
  list.push({name:newBusiness.value, logo:tempLogo});
  localStorage.setItem("biz", JSON.stringify(list));
  newBusiness.value="";
  tempLogo=null;
  loadBusinesses();
}

function loadBusinesses(){
  const list=JSON.parse(localStorage.getItem("biz"));
  business.innerHTML="";
  list.forEach((b,i)=>{
    const o=document.createElement("option");
    o.value=i;
    o.textContent=b.name;
    business.appendChild(o);
  });
  business.selectedIndex=0;
}

/* ---------- DOCUMENTO ---------- */
async function createPDF(){
  if(!amount.value || !client.value){
    alert("Completa los datos");
    return;
  }

  const list=JSON.parse(localStorage.getItem("biz"));
  const biz=list[business.value];

  const base=parseFloat(amount.value);
  const ivaP=parseFloat(ivaPercent.value||0);
  const iva=type.value==="Factura"? base*(ivaP/100):0;
  const total=base+iva;

  const pdf=document.createElement("div");
  pdf.style.padding="30px";
  pdf.innerHTML=`
    <div style="position:relative">
      ${type.value==="Cotización"?`
      <div style="position:absolute;top:40%;left:10%;
      transform:rotate(-30deg);font-size:48px;opacity:0.15">
      COTIZACIÓN</div>`:""}
      <div style="text-align:center">
        ${biz.logo?`<img src="${biz.logo}" style="max-height:80px"><br>`:""}
        <h2>${biz.name}</h2>
      </div>
      <hr>
      <p><b>${type.value}</b></p>
      <p>Cliente: ${client.value}</p>
      <p>Concepto: ${concept.value}</p>
      <p>Subtotal: ${base.toFixed(2)} ${currency.value}</p>
      ${iva>0?`<p>IVA (${ivaP}%): ${iva.toFixed(2)} ${currency.value}</p>`:""}
      <h3>Total: ${total.toFixed(2)} ${currency.value}</h3>
      <p class="small">${new Date().toLocaleString()}</p>
    </div>
  `;

  const blob = await html2pdf().from(pdf).output('blob');

  saveHistory(type.value,total,currency.value);
  sharePDF(blob);
}

/* ---------- HISTORIAL ---------- */
function saveHistory(type,total,currency){
  const h=JSON.parse(localStorage.getItem("hist")||"[]");
  h.unshift({
    type:type,
    total:total.toFixed(2),
    currency:currency,
    date:new Date().toLocaleString()
  });
  localStorage.setItem("hist",JSON.stringify(h));
  loadHistory();
}

function loadHistory(){
  history.innerHTML="";
  const h=JSON.parse(localStorage.getItem("hist")||"[]");
  h.forEach(d=>{
    const div=document.createElement("div");
    div.className="list-item";
    div.innerHTML=`<b>${d.type}</b> • ${d.total} ${d.currency}<br>
    <span class="small">${d.date}</span>`;
    history.appendChild(div);
  });
}

/* ---------- SHARE ---------- */
async function sharePDF(blob){
  const file=new File([blob],"documento.pdf",{type:"application/pdf"});
  await navigator.share({
    files:[file],
    title:"Documento"
  });
}
</script>

</body>
</html>