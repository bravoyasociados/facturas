<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Invoice iOS Pro</title>
<meta name="theme-color" content="#007aff">

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
:root{
--bg:#f2f2f7;
--card:rgba(255,255,255,.75);
--text:#1c1c1e;
--primary:#007aff;
}
@media (prefers-color-scheme: dark){
:root{
--bg:#000;
--card:rgba(28,28,30,.75);
--text:#f2f2f7;
}}
body{
margin:0;
background:var(--bg);
font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display";
color:var(--text);
}
.hidden{display:none}
.lock{
height:100vh;
display:flex;
flex-direction:column;
justify-content:center;
align-items:center;
text-align:center;
padding:20px;
}
.logo img{
max-height:90px;
margin-bottom:15px;
}
button{
width:100%;
max-width:300px;
padding:14px;
border-radius:16px;
border:none;
background:var(--primary);
color:#fff;
font-size:16px;
}
.app{
max-width:900px;
margin:auto;
padding:20px;
}
.card{
background:var(--card);
backdrop-filter:blur(25px);
border-radius:22px;
padding:20px;
}
</style>
</head>

<body>

<!-- BLOQUEO -->
<div id="lock" class="lock">
  <div class="logo">
    <img src="logotipo.JPG" alt="Logotipo">
  </div>
  <h2>Invoice iOS</h2>
  <p id="status">AutenticaciÃ³n requerida</p>
  <button onclick="auth()">Continuar con Face ID</button>
</div>

<!-- APP -->
<div id="app" class="app hidden">
  <div class="logo" style="text-align:center">
    <img src="logotipo.JPG" alt="Logotipo" style="max-height:80px">
  </div>
  <div class="card">
    <h3>âœ… Acceso concedido</h3>
    <p>Face ID verificado correctamente.</p>
    <button onclick="pdf()">Probar PDF</button>
  </div>
</div>

<script>
const PASSKEY_FLAG = "invoice_passkey_ok";

/* Utils */
function randomBuffer(len = 32){
  return crypto.getRandomValues(new Uint8Array(len));
}

/* FACE ID FLOW CORRECTO */
async function auth(){
  if(!window.PublicKeyCredential){
    alert("Este navegador no soporta Face ID web");
    return;
  }

  const status = document.getElementById("status");

  try{
    /* REGISTRO (solo una vez) */
    if(!localStorage.getItem(PASSKEY_FLAG)){
      status.innerText = "Registrando Face IDâ€¦";

      await navigator.credentials.create({
        publicKey:{
          challenge: randomBuffer(),
          rp:{
            name:"Invoice iOS",
            id: location.hostname   // ðŸ”‘ CLAVE para GitHub Pages
          },
          user:{
            id: randomBuffer(),
            name:"usuario@local",
            displayName:"Usuario Invoice"
          },
          pubKeyCredParams:[
            {type:"public-key", alg:-7}
          ],
          authenticatorSelection:{
            authenticatorAttachment:"platform",
            userVerification:"required"
          },
          timeout:60000,
          attestation:"none"
        }
      });

      localStorage.setItem(PASSKEY_FLAG,"true");
    }

    /* LOGIN */
    status.innerText = "Verificando Face IDâ€¦";

    await navigator.credentials.get({
      publicKey:{
        challenge: randomBuffer(),
        rpId: location.hostname, // ðŸ”‘ MISMO rpId
        userVerification:"required",
        timeout:60000
      }
    });

    /* DESBLOQUEO */
    document.getElementById("lock").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");

  }catch(err){
    console.error(err);
    alert("Face ID cancelado o fallido");
  }
}

/* DEMO */
function pdf(){
  html2pdf().from(document.body).save("invoice-demo.pdf");
}
</script>

</body>
</html>
