<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Invoice PWA</title>

<style>
:root {
  --bg:#f2f2f7;
  --card:#fff;
  --text:#000;
  --primary:#007aff;
}
@media (prefers-color-scheme: dark) {
  :root {
    --bg:#000;
    --card:#1c1c1e;
    --text:#fff;
  }
}
body {
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont;
  background:var(--bg);
  color:var(--text);
}
.screen {display:none;padding:24px}
.screen.active{display:block}
.card {
  background:var(--card);
  border-radius:16px;
  padding:20px;
  margin-bottom:16px;
}
input,select,button {
  width:100%;
  padding:14px;
  border-radius:12px;
  border:none;
  margin-top:10px;
  font-size:16px;
}
button {background:var(--primary);color:#fff}
.logo{text-align:center;margin-bottom:20px}
.logo img{max-height:70px}
.list-item{padding:12px;border-bottom:1px solid #ccc;font-size:14px}
.small{font-size:13px;opacity:.7}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="screen active">
  <div class="logo"><img src="logotipo.jpg"></div>
  <div class="card">
    <h2>Acceso</h2>
    <input type="password" id="pin" placeholder="Código">
    <button onclick="login()">Entrar</button>
  </div>
</div>

<!-- APP -->
<div id="app" class="screen">
  <div class="logo"><img src="logotipo.jpg"></div>

  <!-- NEGOCIO -->
  <div class="card">
    <h3>Negocio</h3>
    <select id="business"></select>
    <input id="newBusiness" placeholder="Nuevo negocio">
    <button onclick="addBusiness()">Agregar negocio</button>
  </div>

  <!-- DOCUMENTO -->
  <div class="card">
    <h3>Nuevo documento</h3>
    <select id="type">
      <option>Factura</option>
      <option>Cotización</option>
    </select>
    <input id="client" placeholder="Cliente">
    <input id="concept" placeholder="Concepto">
    <input id="amount" type="number" placeholder="Importe">
    <select id="currency">
      <option>MXN</option>
      <option>USD</option>
      <option>EUR</option>
    </select>
    <button onclick="saveDoc()">Guardar</button>
  </div>

  <!-- HISTORIAL -->
  <div class="card">
    <h3>Historial</h3>
    <div id="history"></div>
  </div>

  <button onclick="logout()">Cerrar sesión</button>
</div>

<script>
const PIN="28053";

function show(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function login(){
  const pin=document.getElementById('pin').value;
  if(pin===PIN){
    if(!localStorage.getItem("registered")){
      registerBiometric();
      localStorage.setItem("registered","1");
    }
    show("app");
    loadAll();
  } else authenticateBiometric();
}

function logout(){show("login")}

async function registerBiometric(){
  if(!window.PublicKeyCredential) return;
  try{
    await navigator.credentials.create({
      publicKey:{
        challenge:new Uint8Array(32),
        rp:{name:"Invoice PWA"},
        user:{id:new Uint8Array(16),name:"user",displayName:"User"},
        pubKeyCredParams:[{type:"public-key",alg:-7}],
        authenticatorSelection:{authenticatorAttachment:"platform",userVerification:"required"}
      }
    });
    localStorage.setItem("bio","1");
  }catch{}
}

async function authenticateBiometric(){
  if(!localStorage.getItem("bio")) return alert("Ingresa el código");
  try{
    await navigator.credentials.get({
      publicKey:{challenge:new Uint8Array(32),userVerification:"required"}
    });
    show("app"); loadAll();
  }catch{alert("Cancelado")}
}

function loadAll(){
  loadBusinesses();
  loadHistory();
  if(Notification && Notification.permission!=="granted"){
    Notification.requestPermission();
  }
}

function addBusiness(){
  const b=document.getElementById('newBusiness').value;
  if(!b) return;
  const list=JSON.parse(localStorage.getItem("biz")||"[]");
  list.push(b);
  localStorage.setItem("biz",JSON.stringify(list));
  loadBusinesses();
}

function loadBusinesses(){
  const sel=document.getElementById("business");
  sel.innerHTML="";
  const list=JSON.parse(localStorage.getItem("biz")||"[]");
  list.forEach(b=>{
    const o=document.createElement("option");
    o.textContent=b; sel.appendChild(o);
  });
}

function saveDoc(){
  const doc={
    type:type.value,
    client:client.value,
    concept:concept.value,
    amount:amount.value,
    currency:currency.value,
    business:business.value,
    date:new Date().toLocaleString()
  };
  const h=JSON.parse(localStorage.getItem("hist")||"[]");
  h.unshift(doc);
  localStorage.setItem("hist",JSON.stringify(h));
  loadHistory();
  if(Notification.permission==="granted"){
    new Notification("Documento guardado",{body:doc.type+" - "+doc.amount+" "+doc.currency});
  }
}

function loadHistory(){
  const h=JSON.parse(localStorage.getItem("hist")||"[]");
  history.innerHTML="";
  h.forEach(d=>{
    const div=document.createElement("div");
    div.className="list-item";
    div.innerHTML=`<b>${d.type}</b> • ${d.amount} ${d.currency}<br>
    ${d.client} — ${d.business}<br>
    <span class="small">${d.date}</span>`;
    history.appendChild(div);
  });
}
</script>

</body>
</html>
